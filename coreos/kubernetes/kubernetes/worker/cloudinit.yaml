#cloud-config

write_files:
  - path: /etc/kubernetes/worker-kubeconfig.yaml
    permissions: 0600
    owner: root
    content: |
      apiVersion: v1
      kind: Config
      clusters:
      - name: local
        cluster:
          certificate-authority: /etc/kubernetes/ssl/ca.pem
      users:
      - name: kubelet
        user:
          client-certificate: /etc/kubernetes/ssl/worker.pem
          client-key: /etc/kubernetes/ssl/worker-key.pem
      contexts:
      - context:
          cluster: local
          user: kubelet
        name: kubelet-context
      current-context: kubelet-context
  - path: /etc/kubernetes/ssl/worker-key.pem
    permissions: 0600
    owner: root
    content: |
      -----BEGIN RSA PRIVATE KEY-----
      MIIEpAIBAAKCAQEAupFzFT0mFKDYyopiyWYERXU0SzMLqR5WEv6SOG7wFzglx2sK
      PKzvf3RDGIoBvn5x+9uRxiZnQ5w/+AB4bI+9m1U98FhiewdIEe1BX2felWarQLAf
      iSgWwlvhDVO1mvkCdcpI1iHO4SDSyoQK636ZH4NilodmgAKw8Wnp3QggRTq7QCqS
      dAwB5qiEkbOIXx1OlV/Y3j443vrHCl8S2hrDaK1qF2DNdo/SA55cime8eO8Ni9rB
      K5debH7CidGiZZDtb628ObxuVDLj1jGxOqy2bDE7j3z1kMFLoEQt9/daBodPiDtd
      Qe5hpbVi1/IGaOaMXnsSjmHDB3tjrksrKPMjtwIDAQABAoIBAQChBLtgT0A4eYHh
      fII589Qn5jnV1R5xPX9oMVIdZpHMWGcyr01MhKzHQZ5O5X0P3a2egyhS7f4duhLz
      heRpPb2U/ILSllWYfPZUkoHjR5AxPUT8NYViKLlL0WRwzhhkwhi/dHBcbx1P67ZB
      lqieCss5CXnjFMUAIlJ4aMKwQz0mwUjhTTReUFvcI3X5w6tl4kp6gONxuZTz+mtc
      CpYLf3fRQXe7O+3A3XuqC9HGrUkk0M6ylKVkvXv9NBdhDGBiz7iW1VG3A8kSdy7S
      j2tlqtlFzPl+3aJ51QJEY9hSYcbbta8uEhuTkMpiuF+KOw0t+gooldJR0htvHBfc
      qEhcWsKhAoGBAO9jrU0Ytsw9qQKOw56vkdi8rTybzOABTZFjcfd+KGCTBsx9XuLg
      rTjmi7u6jtnX23ZcQjNqDrRBclioeQrW1ROi7+mzu03GoDu2AQI4g35PSLMd0Dbd
      gsTDQ0OrpZIlndV7vDYinvWswQF/b/oZ17B4nX6Vvt2G5jNcnphuxKUPAoGBAMeD
      f6TgND3LsD927meqJGInnbNSQIIpx5u2H/FNmgFb9XRGpibQYfnDmJAEpt+rMmfk
      VNXy1hCwKsMqBpn4FKUKyM8b/U6Lj+rN1Xd4K8bS88ddhRdNvxCg7MMhCEOFuDYv
      3brX9eppyNbBtTQkX025YlAJmQ0gYU6ocjEuDSbZAoGAWg0H6wGJ+giT5DdqFO58
      kahgDnWZOwaidDeRboVRkQqduxzKLdRQtR/cnpDOHdpaXwrTiF20DFC2P+2YIuCv
      pMRdNW973QUDz5JmjLxPkpsmgOKNKaZoA7ZkPjd6gCCQX/c81KxvWYFT1UloCQ/h
      mCu3KyAPfWu6esWzjynT5TcCgYEArnvHTwcxSPXxLp+xggGfjiP9XA1ME0m8ouYV
      a3AlhpjIwibjOkC13rv7mcAnvKa5D3j15KJaKgAXddU0LsVyMKCM2+wrjNyrQXs/
      /BqhlmF5B1s3gRjiRwWl6kTiOEMixmj4LmaeT6KyHXcNJQvGOXAulba/Hma6ExNn
      wrD2mYkCgYBWavY9pZrKeBh55ZZTakIRQR+0xmFqQmWBsKvUSHM1i1tQFz/Y0dSg
      vcwWdGXs+BdG5fGC6EvJQXt8CZDzJ6AGShhIApyxDlKaM4hBJ6FOfSVj3SlLV93J
      4cPZCwoQjAwgrAxYF81K8Cf2AmM9dDlqDSwbGFw0FON0mmw9mTo90A==
      -----END RSA PRIVATE KEY-----
  - path: /etc/kubernetes/ssl/worker.pem
    permissions: 0600
    owner: root
    content: |
      -----BEGIN CERTIFICATE-----
      MIICpDCCAYwCCQCkxnU1bw3BPDANBgkqhkiG9w0BAQUFADASMRAwDgYDVQQDEwdr
      dWJlLWNhMB4XDTE2MDUyNTE5MTQzM1oXDTE3MDUyNTE5MTQzM1owFjEUMBIGA1UE
      AxMLa3ViZS13b3JrZXIwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC6
      kXMVPSYUoNjKimLJZgRFdTRLMwupHlYS/pI4bvAXOCXHawo8rO9/dEMYigG+fnH7
      25HGJmdDnD/4AHhsj72bVT3wWGJ7B0gR7UFfZ96VZqtAsB+JKBbCW+ENU7Wa+QJ1
      ykjWIc7hINLKhArrfpkfg2KWh2aAArDxaendCCBFOrtAKpJ0DAHmqISRs4hfHU6V
      X9jePjje+scKXxLaGsNorWoXYM12j9IDnlyKZ7x47w2L2sErl15sfsKJ0aJlkO1v
      rbw5vG5UMuPWMbE6rLZsMTuPfPWQwUugRC3391oGh0+IO11B7mGltWLX8gZo5oxe
      exKOYcMHe2OuSyso8yO3AgMBAAEwDQYJKoZIhvcNAQEFBQADggEBAIi+PSwJPmlF
      1b4uL/dNAi8trVRa60PGEJaT01qV078WLYo7Q+nN54Cw0/wzH+bCY7gQiWlgT2qd
      Zy6dFkTzXlpu9FsApVrc2y76eyAWQJAzaOi3zOMzFO/k9HHP4YNUITUV45//CDFL
      Mxh6/i49Uud4Qrsd71igKVcf5U3JBDkWT1/GuIG06S9JCyitnLD9y6GM41Q1nc3l
      lSh/wCmWY1IIUs5k6FbOvm7lByvBFIWsgHeMGnX3fRFz8fxugFaUVcn9dTH7IZkX
      /npZkNu4WdpkUsWp46nJIZiqRYkN+9RmDHvz2pmrp//sk+pMGX39fdyXMT2bj1tw
      ixcKrJznj4U=
      -----END CERTIFICATE-----
  - path: /etc/kubernetes/ssl/ca.pem
    permissions: 0600
    owner: root
    content: |
      -----BEGIN CERTIFICATE-----
      MIIDGjCCAgKgAwIBAgIJAIGuaQDbLIOBMA0GCSqGSIb3DQEBBQUAMBIxEDAOBgNV
      BAMTB2t1YmUtY2EwHhcNMTYwNTI1MTkxNDMzWhcNNDMxMDExMTkxNDMzWjASMRAw
      DgYDVQQDEwdrdWJlLWNhMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA
      x/oil7eFKzaoOMkeQ7s93EaydC/+EPkbdKD2Q3wtbkzdMo2o5oKajqsU/WuQQXoa
      /XzXPQl61ovSNnscDqzTQkB7X+OdTUOccE8gdsBzs2LIrq9QeidwAAzCkGpMnOzF
      CfhJ4e6kQGF4gZqNlB5xxh8nmp3AdPn2Z0GMDJWQh3F96kP152gX4UZAj/UkfNsi
      gRa/5zVgo03hC1SPF5UVbmYshrESwyPN0kpEHf77fmxz3agxUaQBrVVtBCgw/5Fr
      rUosjsOsddMIumUiQiqhuOv61MPCH3dDbG+jxwnfBrCLmxYkKijHyjoUnCiKMQ4y
      K6fCe4xe/Snsirw5wV8N2wIDAQABo3MwcTAdBgNVHQ4EFgQUwo/i4oaO0t3iKbQ2
      J15HhZO3DeYwQgYDVR0jBDswOYAUwo/i4oaO0t3iKbQ2J15HhZO3DeahFqQUMBIx
      EDAOBgNVBAMTB2t1YmUtY2GCCQCBrmkA2yyDgTAMBgNVHRMEBTADAQH/MA0GCSqG
      SIb3DQEBBQUAA4IBAQB2ZZMXpBVHbQYRM73srctK0/PuqglygnJX2VPtus8mFF+p
      mnJWN2R6JCXBAtv/dlDedZPZI9MlbfDqlHSM9jCNhW4TcFTEkcGxZaO1Of7tNop7
      hxhSsQJcwaEaaFVHr0/bf2ey7NBuEsHdvitH7Q4kUoNcCVViPlgovwKJ9lp4FPMi
      uO0J3ppaIpQNJx2IqkARv4aG5gFJJyQ+GfAkSVi6+xtDnodqScH8WIDjJEfgN7Np
      bS2tYX/uiyvfPoUBe9xdTGnvtTKzDq1FZxlFjE1iEY01ugbjTA0t2WLfAtn4DhIN
      /7xMPQmO9FWKtVgvmhd2otckpt2CPfdRsJbo9+gg
      -----END CERTIFICATE-----
  - path: /etc/kubernetes/manifests/kube-proxy.yaml
    permissions: 0600
    owner: root
    content: |
      apiVersion: v1
      kind: Pod
      metadata:
        name: kube-proxy
        namespace: kube-system
      spec:
        hostNetwork: true
        containers:
        - name: kube-proxy
          image: quay.io/coreos/hyperkube:$hyperkube_version
          command:
          - /hyperkube
          - proxy
          - --master=https://10.0.0.2
          - --kubeconfig=/etc/kubernetes/worker-kubeconfig.yaml
          - --proxy-mode=iptables
          securityContext:
            privileged: true
          volumeMounts:
            - mountPath: /etc/ssl/certs
              name: "ssl-certs"
            - mountPath: /etc/kubernetes/worker-kubeconfig.yaml
              name: "kubeconfig"
              readOnly: true
            - mountPath: /etc/kubernetes/ssl
              name: "etc-kube-ssl"
              readOnly: true
        volumes:
          - name: "ssl-certs"
            hostPath:
              path: "/usr/share/ca-certificates"
          - name: "kubeconfig"
            hostPath:
              path: "/etc/kubernetes/worker-kubeconfig.yaml"
          - name: "etc-kube-ssl"
            hostPath:
              path: "/etc/kubernetes/ssl"
  - path: /etc/environment-kubelet
    permissions: 0600
    owner: root
    content: |
      KUBELET_VERSION=$hyperkube_version
  - path: /etc/flannel/options.env
    permissions: 0600
    owner: root
    content: |
      FLANNELD_IFACE=$flanneld_iface
      FLANNELD_ETCD_ENDPOINTS=$etcd_endpoints

coreos:
  update:
    reboot-strategy: $reboot_strategy
  units:
    - name: flanneld.service
      drop-ins:
        - name: 40-ExecStartPre-symlink.conf
          content: |
            [Service]
            ExecStartPre=/usr/bin/ln -sf /etc/flannel/options.env /run/flannel/options.env
      command: start
    - name: docker.service
      drop-ins:
        - name: 40-flannel.conf
          content: |
            [Unit]
            Requires=flanneld.service
            After=flanneld.service
      command: start
    - name: kubelet.service
      content : |
        [Service]
        ExecStartPre=/usr/bin/mkdir -p /etc/kubernetes/manifests
        EnvironmentFile=/etc/environment
        EnvironmentFile=/etc/environment-kubelet
        ExecStart=/usr/lib/coreos/kubelet-wrapper \
          --api-servers=https://10.0.0.2 \
          --network-plugin-dir=/etc/kubernetes/cni/net.d \
          --register-node=true \
          --allow-privileged=true \
          --config=/etc/kubernetes/manifests \
          --hostname-override=${COREOS_PRIVATE_IPV4} \
          --kubeconfig=/etc/kubernetes/worker-kubeconfig.yaml \
          --tls-cert-file=/etc/kubernetes/ssl/worker.pem \
          --tls-private-key-file=/etc/kubernetes/ssl/worker-key.pem
        Restart=always
        RestartSec=10
        [Install]
        WantedBy=multi-user.target
      command: start
      enable: true
